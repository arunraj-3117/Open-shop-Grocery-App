<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order Page - Working Fix</title>
  <style>
    body { font-family: Arial, sans-serif; background: #2a5082; color: white; padding: 20px; }
    .container { display: flex; gap: 40px; max-width: 1200px; margin: auto; }
    .left, .right { flex: 1; }
    h2 { margin-bottom: 15px; }
    .product-item { background: #1f3b61; margin-bottom: 20px; padding: 15px; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; border-radius: 6px; border: none; margin-top: 5px; font-size: 16px; }
    .total { margin-top: 8px; font-weight: bold; }
    .grand-total { margin-top: 25px; font-size: 22px; font-weight: bold; color: yellow; }
    /* Added button styles */
    #paymentButtons {
      margin-top: 20px;
      display: flex;
      gap: 20px;
    }
    button {
      flex: 1;
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      color: #2a5082;
      background: yellow;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #ffd633;
    }
    #orderSummary {
      margin-top: 30px;
      background: #1f3b61;
      padding: 20px;
      border-radius: 8px;
      display: none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="left">
    <h2>Your Cart</h2>
    <div id="productList">Loading products...</div>
    <div class="grand-total" id="grandTotal">Grand Total: ₹ 0</div>
  </div>

  <div class="right">
    <h2>Your Details</h2>
    <label>Name:</label>
    <input type="text" id="name" readonly placeholder="Loading user name..." />

    <label>Customer ID:</label>
    <input type="text" id="customerId" readonly placeholder="Loading customer ID..." />

    <label>Email:</label>
    <input type="email" id="email" readonly placeholder="Loading email..." />

    <label>Mobile Number:</label>
    <input type="text" id="mobile" placeholder="Enter mobile number" />

    <label>Address:</label>
    <textarea id="address" rows="4" placeholder="Enter delivery address"></textarea>

    <!-- Payment buttons added here -->
    <div id="paymentButtons">
      <button id="onlinePaymentBtn">Online Payment</button>
      <button id="codBtn">Cash on Delivery</button>
    </div>

    <!-- Order summary shown here -->
    <div id="orderSummary"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getDatabase, ref, get, child, push, set } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD3wvj7pLB5AsahfRE_xd4AmEkGfRuEIZ8",
    authDomain: "authentication-app-cf09d.firebaseapp.com",
    databaseURL: "https://authentication-app-cf09d-default-rtdb.firebaseio.com",
    projectId: "authentication-app-cf09d",
    storageBucket: "authentication-app-cf09d.appspot.com",
    messagingSenderId: "82317472416",
    appId: "1:82317472416:web:6d0bc95248ca455c834fc5"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth();

  // Elements
  const nameInput = document.getElementById("name");
  const customerIdInput = document.getElementById("customerId");
  const emailInput = document.getElementById("email");
  const mobileInput = document.getElementById("mobile");
  const addressInput = document.getElementById("address");
  const productList = document.getElementById("productList");
  const grandTotalElem = document.getElementById("grandTotal");
  const orderSummaryDiv = document.getElementById("orderSummary");

  let currentUser = null;
  let orderDetails = [];

  // Load user info from Firebase Auth + Realtime DB
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Please log in to view this page.");
      window.location.href = "signin.html";
      return;
    }
    currentUser = user;

    const uid = user.uid;
    const dbRef = ref(database);

    get(child(dbRef, `users/${uid}`)).then((snapshot) => {
      if (snapshot.exists()) {
        const userData = snapshot.val();

        // Fill user details form fields
        nameInput.value = userData.username || user.displayName || "";
        customerIdInput.value = userData.customerid || uid.slice(-6);
        emailInput.value = userData.email || user.email || "";
      } else {
        // Fallback if user data not found in DB
        nameInput.value = user.displayName || "";
        customerIdInput.value = uid.slice(-6);
        emailInput.value = user.email || "";
      }
    }).catch((error) => {
      console.error("Error fetching user data:", error);
    });

    loadAndRenderProducts();
  });

  function loadAndRenderProducts() {
    orderDetails = JSON.parse(localStorage.getItem("orderDetails") || "[]");
    if (orderDetails.length === 0) {
      productList.innerHTML = "<p>No products to display.</p>";
      grandTotalElem.textContent = "Grand Total: ₹ 0";
      return;
    }

    let total = 0;
    productList.innerHTML = ""; // Clear existing

    orderDetails.forEach((item) => {
      total += Number(item.price) || 0;

      const productHTML = `
        <div class="product-item">
          <h3>${item.name}</h3>
          <p>Category: ${item.category}</p>
          <p>Price: ₹${item.price}</p>
          <img src="${item.imageUrl}" alt="${item.name}" style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-top: 10px;" />
        </div>
      `;
      productList.insertAdjacentHTML("beforeend", productHTML);
    });

    grandTotalElem.textContent = `Grand Total: ₹ ${total.toFixed(2)}`;
  }

  // Validate mobile and address before placing order
  function validateOrder() {
    if (!mobileInput.value.trim()) {
      alert("Please enter your mobile number.");
      return false;
    }
    if (!addressInput.value.trim()) {
      alert("Please enter your delivery address.");
      return false;
    }
    return true;
  }

  function placeOrder(paymentMethod) {
    if (!validateOrder()) return;

    const orderData = {
      userId: currentUser.uid,
      name: nameInput.value,
      customerId: customerIdInput.value,
      email: emailInput.value,
      mobile: mobileInput.value.trim(),
      address: addressInput.value.trim(),
      paymentMethod,
      products: orderDetails,
      grandTotal: grandTotalElem.textContent.replace("Grand Total: ₹ ", ""),
      orderDate: new Date().toISOString()
    };

    // Push order to "cart_orders"
    const ordersRef = ref(database, "cart_orders");
    const newOrderRef = push(ordersRef);

    set(newOrderRef, orderData)
      .then(() => {
        showOrderSummary(orderData);
        clearForm();
      })
      .catch((error) => {
        alert("Failed to place order: " + error.message);
      });
  }

  function showOrderSummary(data) {
    orderSummaryDiv.style.display = "block";
    orderSummaryDiv.textContent = `
Order Placed Successfully!

Name: ${data.name}
Customer ID: ${data.customerId}
Email: ${data.email}
Mobile: ${data.mobile}
Address: ${data.address}
Payment Method: ${data.paymentMethod}
Order Date: ${new Date(data.orderDate).toLocaleString()}

Products:
${data.products.map(p => `- ${p.name} (₹${p.price})`).join("\n")}

Grand Total: ₹${data.grandTotal}
    `;
  }

  function clearForm() {
    mobileInput.value = "";
    addressInput.value = "";
    // optionally clear cart or localStorage here if needed
  }

  document.getElementById("onlinePaymentBtn").addEventListener("click", () => {
    placeOrder("Online Payment");
  });

  document.getElementById("codBtn").addEventListener("click", () => {
    placeOrder("Cash on Delivery");
  });

</script>

</body>
</html>
